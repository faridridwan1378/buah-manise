<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Toko Buah Cloud — Firebase</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <style>
    :root{color-scheme: light;}
    .glass{backdrop-filter: blur(10px); background: color-mix(in oklab, white 72%, transparent);}
    .shadow-soft{box-shadow: 0 18px 60px rgba(0,0,0,.12);}
    .ring-soft{box-shadow: 0 0 0 6px rgba(34,197,94,.10);}
    .fade-in{animation: fadein .25s ease-out;}
    @keyframes fadein{from{opacity:0; transform: translateY(6px)}to{opacity:1; transform: translateY(0)}}
    .no-scrollbar::-webkit-scrollbar{display:none}
    .no-scrollbar{scrollbar-width:none}
    .grid-auto{grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));}
    .mono{font-variant-numeric: tabular-nums;}
    canvas.confetti{position: fixed; inset: 0; pointer-events:none; z-index: 80;}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-emerald-50 via-white to-amber-50 text-slate-800">
  <!-- Topbar -->
  <header class="sticky top-0 z-40 border-b border-slate-200/60 bg-white/70 glass">
    <div class="mx-auto max-w-7xl px-4 py-3 flex items-center gap-3">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-gradient-to-br from-emerald-500 to-lime-400 shadow-soft"></div>
        <div>
          <div class="font-semibold leading-tight">Toko Buah Cloud</div>
          <div class="text-xs text-slate-500 -mt-0.5" id="subtitle">Firebase + Firestore (Realtime)</div>
        </div>
      </div>

      <div class="ml-auto flex items-center gap-2">
        <div class="hidden md:flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs">
          <span class="inline-flex items-center gap-2">
            <span id="connDot" class="h-2 w-2 rounded-full bg-amber-500"></span>
            <span id="connText" class="text-slate-700">Mode Demo (belum terhubung)</span>
          </span>
          <span class="text-slate-300">|</span>
          <span class="text-slate-500" id="roleBadge">guest</span>
        </div>

        <button id="btnOpenSetup" class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-slate-50">Setup Firebase</button>
        <button id="btnCart" class="relative rounded-xl bg-slate-900 px-3 py-2 text-sm text-white hover:bg-slate-800">
          Keranjang
          <span id="cartCount" class="absolute -top-2 -right-2 inline-flex h-6 min-w-6 items-center justify-center rounded-full bg-emerald-500 px-1 text-xs font-semibold">0</span>
        </button>
        <button id="btnLogin" class="rounded-xl bg-emerald-600 px-3 py-2 text-sm text-white hover:bg-emerald-700">Login</button>
        <button id="btnLogout" class="hidden rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-slate-50">Logout</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="mx-auto max-w-7xl px-4 py-6">
    <!-- Hero -->
    <section class="rounded-3xl border border-slate-200 bg-white p-6 shadow-soft overflow-hidden relative">
      <div class="absolute -right-20 -top-24 h-72 w-72 rounded-full bg-gradient-to-br from-emerald-200 to-amber-200 blur-2xl opacity-60"></div>
      <div class="absolute -left-24 -bottom-24 h-72 w-72 rounded-full bg-gradient-to-br from-lime-200 to-emerald-200 blur-2xl opacity-60"></div>
      <div class="relative flex flex-col md:flex-row md:items-center gap-6">
        <div class="flex-1">
          <div class="inline-flex items-center gap-2 rounded-full bg-emerald-50 px-3 py-1 text-xs font-medium text-emerald-700 border border-emerald-100">
            <span class="h-2 w-2 rounded-full bg-emerald-500"></span>
            Real-time inventory & order workflow
          </div>
          <h1 class="mt-3 text-2xl md:text-3xl font-semibold tracking-tight">Aplikasi Web Toko Buah Berbasis Cloud</h1>
          <p class="mt-2 text-slate-600 leading-relaxed">
            Kelola produk, stok masuk/keluar, pembelian supplier, order pelanggan, biaya operasional, dan biaya pengiriman.
            Alur checkout → admin tentukan ongkir → pelanggan konfirmasi pembayaran → notifikasi & tampilan terima kasih.
          </p>
          <div class="mt-4 flex flex-wrap items-center gap-2">
            <button id="btnGoCatalog" class="rounded-xl bg-slate-900 px-4 py-2 text-sm text-white hover:bg-slate-800">Mulai Belanja</button>
            <button id="btnGoDashboard" class="rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm hover:bg-slate-50">Dashboard</button>
            <div class="text-xs text-slate-500">Tips: klik “Setup Firebase” untuk mode cloud.</div>
          </div>
        </div>
        <div class="w-full md:w-[380px]">
          <div class="rounded-2xl border border-slate-200 bg-gradient-to-br from-white to-emerald-50 p-4">
            <div class="flex items-center justify-between">
              <div class="text-sm font-semibold">Status Sistem</div>
              <span id="chipRealtime" class="rounded-full bg-amber-100 text-amber-800 px-2 py-0.5 text-xs font-medium">DEMO</span>
            </div>
            <div class="mt-3 grid grid-cols-2 gap-3">
              <div class="rounded-xl bg-white border border-slate-200 p-3">
                <div class="text-xs text-slate-500">User</div>
                <div class="mt-1 font-semibold" id="statUser">Guest</div>
              </div>
              <div class="rounded-xl bg-white border border-slate-200 p-3">
                <div class="text-xs text-slate-500">Role</div>
                <div class="mt-1 font-semibold" id="statRole">—</div>
              </div>
              <div class="rounded-xl bg-white border border-slate-200 p-3">
                <div class="text-xs text-slate-500">Produk</div>
                <div class="mt-1 font-semibold mono" id="statProducts">0</div>
              </div>
              <div class="rounded-xl bg-white border border-slate-200 p-3">
                <div class="text-xs text-slate-500">Order Aktif</div>
                <div class="mt-1 font-semibold mono" id="statOrders">0</div>
              </div>
            </div>
            <div class="mt-3 text-xs text-slate-500" id="hintRole">Login sebagai customer untuk checkout, atau set role admin di Firestore untuk membuka panel admin.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Tabs -->
    <section class="mt-6">
      <div class="flex flex-wrap gap-2">
        <button data-view="catalog" class="viewBtn rounded-xl bg-slate-900 text-white px-4 py-2 text-sm">Katalog</button>
        <button data-view="customer" class="viewBtn rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm hover:bg-slate-50">Pelanggan</button>
        <button data-view="admin" class="viewBtn rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm hover:bg-slate-50">Admin</button>
        <button data-view="reports" class="viewBtn rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm hover:bg-slate-50">Laporan</button>
      </div>
    </section>

    <!-- Catalog View -->
    <section id="view-catalog" class="mt-6 fade-in">
      <div class="flex flex-col md:flex-row md:items-center gap-3">
        <div class="flex-1">
          <div class="text-lg font-semibold">Katalog Buah</div>
          <div class="text-sm text-slate-500">Pilih buah, tambahkan ke keranjang, lalu checkout.</div>
        </div>
        <div class="flex items-center gap-2">
          <input id="search" class="w-full md:w-72 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm" placeholder="Cari: apel, pisang, dll" />
          <select id="filterCategory" class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm">
            <option value="">Semua Kategori</option>
          </select>
        </div>
      </div>

      <div class="mt-4 grid grid-auto gap-4" id="productsGrid"></div>

      <div id="emptyProducts" class="hidden mt-6 rounded-2xl border border-slate-200 bg-white p-6 text-center text-slate-600">
        Belum ada produk. Jika Anda admin, buka tab Admin → Produk untuk menambahkan.
      </div>
    </section>

    <!-- Customer View -->
    <section id="view-customer" class="mt-6 hidden fade-in">
      <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-soft">
        <div class="flex flex-col md:flex-row md:items-center gap-3">
          <div class="flex-1">
            <div class="text-lg font-semibold">Area Pelanggan</div>
            <div class="text-sm text-slate-500">Riwayat order dan konfirmasi pembayaran.</div>
          </div>
          <div class="text-sm text-slate-600">Anda login sebagai: <span class="font-semibold" id="customerEmail">—</span></div>
        </div>

        <div class="mt-4 grid grid-cols-1 lg:grid-cols-3 gap-4">
          <div class="lg:col-span-2">
            <div class="flex items-center justify-between">
              <div class="font-semibold">Riwayat Order</div>
              <div class="text-xs text-slate-500">Realtime</div>
            </div>
            <div class="mt-3 divide-y divide-slate-100 rounded-2xl border border-slate-200 overflow-hidden" id="customerOrders"></div>
            <div id="emptyCustomerOrders" class="hidden mt-3 rounded-2xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-600">Belum ada order.</div>
          </div>
          <div>
            <div class="font-semibold">Panduan Alur</div>
            <ol class="mt-2 space-y-2 text-sm text-slate-600 list-decimal list-inside">
              <li>Checkout dari katalog → order dibuat (menunggu ongkir).</li>
              <li>Admin menambahkan biaya kirim → Anda menerima total pembayaran.</li>
              <li>Transfer manual → klik “Konfirmasi Pembayaran”.</li>
              <li>Sistem mencatat, menampilkan ucapan terima kasih, dan menulis log notifikasi.</li>
            </ol>

            <div class="mt-4 rounded-2xl border border-emerald-200 bg-emerald-50 p-4 text-sm text-emerald-900">
              <div class="font-semibold">Catatan</div>
              <div class="mt-1">WhatsApp API bersifat opsional; aplikasi ini menyimpan log channel “whatsapp” untuk simulasi.</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Admin View -->
    <section id="view-admin" class="mt-6 hidden fade-in">
      <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-soft">
        <div class="flex flex-col md:flex-row md:items-center gap-3">
          <div class="flex-1">
            <div class="text-lg font-semibold">Panel Admin</div>
            <div class="text-sm text-slate-500">Kelola produk, stok, supplier, pembelian, order, biaya operasional, dan notifikasi.</div>
          </div>
          <div class="text-sm text-slate-600">Login: <span class="font-semibold" id="adminEmail">—</span></div>
        </div>

        <div class="mt-5 flex flex-wrap gap-2">
          <button class="adminTab rounded-xl bg-slate-900 text-white px-4 py-2 text-sm" data-admin="products">Produk & Stok</button>
          <button class="adminTab rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm hover:bg-slate-50" data-admin="suppliers">Supplier</button>
          <button class="adminTab rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm hover:bg-slate-50" data-admin="purchases">Pembelian</button>
          <button class="adminTab rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm hover:bg-slate-50" data-admin="orders">Order & Ongkir</button>
          <button class="adminTab rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm hover:bg-slate-50" data-admin="expenses">Biaya Operasional</button>
          <button class="adminTab rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm hover:bg-slate-50" data-admin="notifications">Log Notifikasi</button>
        </div>

        <!-- Admin: Products -->
        <div id="admin-products" class="mt-5">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="lg:col-span-1">
              <div class="font-semibold">Tambah / Edit Produk</div>
              <form id="productForm" class="mt-3 space-y-3">
                <input type="hidden" id="productId" />
                <div>
                  <label class="text-xs text-slate-500">Nama</label>
                  <input id="productName" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" placeholder="Apel Fuji" required />
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="text-xs text-slate-500">Harga (Rp)</label>
                    <input id="productPrice" type="number" min="0" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" placeholder="25000" required />
                  </div>
                  <div>
                    <label class="text-xs text-slate-500">Stok awal</label>
                    <input id="productStock" type="number" min="0" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" placeholder="20" required />
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="text-xs text-slate-500">Kategori</label>
                    <input id="productCategory" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" placeholder="Buah" />
                  </div>
                  <div>
                    <label class="text-xs text-slate-500">Image URL</label>
                    <input id="productImageUrl" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" placeholder="https://..." />
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <button class="rounded-xl bg-emerald-600 px-4 py-2 text-sm text-white hover:bg-emerald-700" type="submit">Simpan</button>
                  <button id="btnProductReset" class="rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm hover:bg-slate-50" type="button">Reset</button>
                </div>
                <div class="text-xs text-slate-500">Stok akan bertambah saat pembelian supplier, dan berkurang saat checkout.</div>
              </form>
            </div>
            <div class="lg:col-span-2">
              <div class="flex items-center justify-between">
                <div class="font-semibold">Daftar Produk</div>
                <div class="text-xs text-slate-500">Klik item untuk edit</div>
              </div>
              <div class="mt-3 overflow-hidden rounded-2xl border border-slate-200">
                <div class="max-h-[420px] overflow-auto no-scrollbar" id="adminProductsList"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Admin: Suppliers -->
        <div id="admin-suppliers" class="mt-5 hidden">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div>
              <div class="font-semibold">Tambah Supplier</div>
              <form id="supplierForm" class="mt-3 space-y-3">
                <input type="hidden" id="supplierId" />
                <div>
                  <label class="text-xs text-slate-500">Nama</label>
                  <input id="supplierName" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" placeholder="CV Buah Segar" required />
                </div>
                <div>
                  <label class="text-xs text-slate-500">Kontak</label>
                  <input id="supplierContact" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" placeholder="08xx / email" />
                </div>
                <div class="flex items-center gap-2">
                  <button class="rounded-xl bg-emerald-600 px-4 py-2 text-sm text-white hover:bg-emerald-700" type="submit">Simpan</button>
                  <button id="btnSupplierReset" class="rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm hover:bg-slate-50" type="button">Reset</button>
                </div>
              </form>
            </div>
            <div class="lg:col-span-2">
              <div class="font-semibold">Daftar Supplier</div>
              <div class="mt-3 overflow-hidden rounded-2xl border border-slate-200">
                <div class="max-h-[420px] overflow-auto no-scrollbar" id="adminSuppliersList"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Admin: Purchases -->
        <div id="admin-purchases" class="mt-5 hidden">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div>
              <div class="font-semibold">Catat Pembelian Supplier (Stok Masuk)</div>
              <form id="purchaseForm" class="mt-3 space-y-3">
                <div>
                  <label class="text-xs text-slate-500">Supplier</label>
                  <select id="purchaseSupplier" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm"></select>
                </div>
                <div class="rounded-2xl border border-slate-200 bg-slate-50 p-3">
                  <div class="flex items-center justify-between">
                    <div class="text-sm font-semibold">Items</div>
                    <button id="btnAddPurchaseItem" type="button" class="rounded-xl bg-white border border-slate-200 px-3 py-1.5 text-xs hover:bg-slate-50">+ Tambah Item</button>
                  </div>
                  <div id="purchaseItems" class="mt-2 space-y-2"></div>
                </div>
                <div>
                  <label class="text-xs text-slate-500">Catatan</label>
                  <input id="purchaseNote" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" placeholder="No. invoice / catatan" />
                </div>
                <button class="w-full rounded-xl bg-emerald-600 px-4 py-2 text-sm text-white hover:bg-emerald-700" type="submit">Simpan Pembelian & Update Stok</button>
                <div class="text-xs text-slate-500">Total cost dihitung dari (qty × cost/item).</div>
              </form>
            </div>
            <div class="lg:col-span-2">
              <div class="font-semibold">Riwayat Pembelian</div>
              <div class="mt-3 overflow-hidden rounded-2xl border border-slate-200">
                <div class="max-h-[420px] overflow-auto no-scrollbar" id="adminPurchasesList"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Admin: Orders -->
        <div id="admin-orders" class="mt-5 hidden">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="lg:col-span-2">
              <div class="flex items-center justify-between">
                <div class="font-semibold">Daftar Order</div>
                <select id="adminOrderFilter" class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm">
                  <option value="">Semua</option>
                  <option value="Menunggu Konfirmasi Biaya Kirim">Menunggu Ongkir</option>
                  <option value="Menunggu Pembayaran">Menunggu Pembayaran</option>
                  <option value="Pembayaran Dikonfirmasi">Pembayaran Dikonfirmasi</option>
                  <option value="Selesai">Selesai</option>
                </select>
              </div>
              <div class="mt-3 overflow-hidden rounded-2xl border border-slate-200">
                <div class="max-h-[420px] overflow-auto no-scrollbar" id="adminOrdersList"></div>
              </div>
            </div>
            <div>
              <div class="font-semibold">Detail Order</div>
              <div id="adminOrderDetail" class="mt-3 rounded-2xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-700">
                Pilih salah satu order untuk mengatur ongkir dan status.
              </div>
            </div>
          </div>
        </div>

        <!-- Admin: Expenses -->
        <div id="admin-expenses" class="mt-5 hidden">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div>
              <div class="font-semibold">Catat Biaya Operasional</div>
              <form id="expenseForm" class="mt-3 space-y-3">
                <div>
                  <label class="text-xs text-slate-500">Kategori</label>
                  <input id="expenseCategory" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" placeholder="Listrik / Sewa / Kemasan" required />
                </div>
                <div>
                  <label class="text-xs text-slate-500">Jumlah (Rp)</label>
                  <input id="expenseAmount" type="number" min="0" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" placeholder="50000" required />
                </div>
                <div>
                  <label class="text-xs text-slate-500">Catatan</label>
                  <input id="expenseNote" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" placeholder="Opsional" />
                </div>
                <button class="w-full rounded-xl bg-emerald-600 px-4 py-2 text-sm text-white hover:bg-emerald-700" type="submit">Simpan Biaya</button>
              </form>
            </div>
            <div class="lg:col-span-2">
              <div class="font-semibold">Daftar Biaya Operasional</div>
              <div class="mt-3 overflow-hidden rounded-2xl border border-slate-200">
                <div class="max-h-[420px] overflow-auto no-scrollbar" id="adminExpensesList"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Admin: Notifications -->
        <div id="admin-notifications" class="mt-5 hidden">
          <div class="flex items-center justify-between">
            <div class="font-semibold">Log Notifikasi (System & WhatsApp)</div>
            <button id="btnSeedNotif" class="hidden rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm hover:bg-slate-50">Seed Demo</button>
          </div>
          <div class="mt-3 overflow-hidden rounded-2xl border border-slate-200">
            <div class="max-h-[420px] overflow-auto no-scrollbar" id="adminNotificationsList"></div>
          </div>
          <div class="mt-3 text-xs text-slate-500">Catatan: pengiriman WhatsApp asli sebaiknya melalui Firebase Cloud Functions + WA API. Di aplikasi ini dicatat sebagai log.</div>
        </div>

        <div id="adminAccessDenied" class="hidden mt-5 rounded-2xl border border-amber-200 bg-amber-50 p-4 text-amber-900">
          <div class="font-semibold">Akses Ditolak</div>
          <div class="mt-1 text-sm">Tab Admin hanya untuk user dengan role <span class="font-semibold">admin</span>.</div>
        </div>
      </div>
    </section>

    <!-- Reports View -->
    <section id="view-reports" class="mt-6 hidden fade-in">
      <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-soft">
        <div class="flex flex-col md:flex-row md:items-center gap-3">
          <div class="flex-1">
            <div class="text-lg font-semibold">Laporan Ringkas</div>
            <div class="text-sm text-slate-500">Perkiraan berbasis data order & biaya operasional.</div>
          </div>
          <button id="btnRefreshReports" class="rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm hover:bg-slate-50">Refresh</button>
        </div>

        <div class="mt-5 grid grid-cols-1 md:grid-cols-4 gap-4" id="reportCards"></div>

        <div class="mt-5 grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="rounded-2xl border border-slate-200 p-4">
            <div class="font-semibold">Order Terbaru</div>
            <div class="mt-3 overflow-hidden rounded-xl border border-slate-200">
              <div class="max-h-[320px] overflow-auto no-scrollbar" id="reportRecentOrders"></div>
            </div>
          </div>
          <div class="rounded-2xl border border-slate-200 p-4">
            <div class="font-semibold">Biaya Operasional Terbaru</div>
            <div class="mt-3 overflow-hidden rounded-xl border border-slate-200">
              <div class="max-h-[320px] overflow-auto no-scrollbar" id="reportRecentExpenses"></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <footer class="mt-8 pb-10 text-center text-xs text-slate-500">
      <div>Single-page app (HTML + Tailwind + JS) • Firebase Auth + Firestore (opsional demo lokal).</div>
    </footer>
  </main>

  <!-- Cart Drawer -->
  <aside id="cartDrawer" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-slate-900/40" data-close-cart></div>
    <div class="absolute right-0 top-0 h-full w-full max-w-md bg-white shadow-soft border-l border-slate-200 flex flex-col">
      <div class="p-4 border-b border-slate-200 flex items-center justify-between">
        <div>
          <div class="font-semibold">Keranjang</div>
          <div class="text-xs text-slate-500" id="cartMeta">0 item</div>
        </div>
        <button class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-slate-50" data-close-cart>Tutup</button>
      </div>
      <div class="flex-1 overflow-auto no-scrollbar p-4" id="cartItems"></div>
      <div class="border-t border-slate-200 p-4 space-y-3">
        <div class="flex items-center justify-between text-sm">
          <div class="text-slate-600">Subtotal</div>
          <div class="font-semibold mono" id="cartSubtotal">Rp0</div>
        </div>
        <button id="btnCheckout" class="w-full rounded-xl bg-emerald-600 px-4 py-2 text-sm text-white hover:bg-emerald-700">Checkout Order</button>
        <div class="text-xs text-slate-500">Checkout membutuhkan login customer. Stok akan dikurangi saat checkout.</div>
      </div>
    </div>
  </aside>

  <!-- Auth Modal -->
  <div id="authModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-slate-900/40" data-close-auth></div>
    <div class="absolute inset-x-4 top-10 mx-auto max-w-lg rounded-3xl bg-white border border-slate-200 shadow-soft p-5 fade-in">
      <div class="flex items-center justify-between">
        <div>
          <div class="font-semibold" id="authTitle">Login</div>
          <div class="text-xs text-slate-500">Gunakan Email & Password (Firebase Auth)</div>
        </div>
        <button class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-slate-50" data-close-auth>Tutup</button>
      </div>

      <div class="mt-4 grid grid-cols-2 gap-2">
        <button id="btnModeLogin" class="rounded-xl bg-slate-900 text-white px-3 py-2 text-sm">Login</button>
        <button id="btnModeRegister" class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-slate-50">Registrasi</button>
      </div>

      <form id="authForm" class="mt-4 space-y-3">
        <div id="rowName" class="hidden">
          <label class="text-xs text-slate-500">Nama</label>
          <input id="authName" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" placeholder="Nama Anda" />
        </div>
        <div>
          <label class="text-xs text-slate-500">Email</label>
          <input id="authEmail" type="email" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" placeholder="email@contoh.com" required />
        </div>
        <div>
          <label class="text-xs text-slate-500">Password</label>
          <input id="authPassword" type="password" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" placeholder="minimal 6 karakter" required />
        </div>
        <button class="w-full rounded-xl bg-emerald-600 px-4 py-2 text-sm text-white hover:bg-emerald-700" type="submit" id="btnAuthSubmit">Masuk</button>
      </form>

      <div class="mt-3 text-sm text-rose-600" id="authError"></div>

      <div class="mt-4 rounded-2xl border border-slate-200 bg-slate-50 p-4 text-xs text-slate-600">
        <div class="font-semibold">Catatan Role</div>
        <div class="mt-1">User baru otomatis ber-role <span class="font-semibold">customer</span>. Untuk membuat admin, ubah field <span class="font-mono">users/{uid}.role</span> menjadi <span class="font-mono">admin</span> di Firestore.</div>
      </div>
    </div>
  </div>

  <!-- Setup Firebase Modal -->
  <div id="setupModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-slate-900/40" data-close-setup></div>
    <div class="absolute inset-x-4 top-8 mx-auto max-w-3xl rounded-3xl bg-white border border-slate-200 shadow-soft p-5 fade-in">
      <div class="flex items-center justify-between">
        <div>
          <div class="font-semibold">Setup Firebase</div>
          <div class="text-xs text-slate-500">Tempel konfigurasi Web App Firebase Anda (firebaseConfig). Disimpan di LocalStorage.</div>
        </div>
        <button class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-slate-50" data-close-setup>Tutup</button>
      </div>

      <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div>
          <div class="text-sm font-semibold">1) Paste firebaseConfig (JSON / Snippet)</div>
          <textarea id="firebaseConfigInput" class="mt-2 h-52 w-full rounded-2xl border border-slate-200 bg-slate-50 p-3 font-mono text-xs" placeholder='Contoh (boleh JSON murni atau snippet):

const firebaseConfig = {
  apiKey: "...",
  authDomain: "...",
  projectId: "...",
  storageBucket: "...",
  messagingSenderId: "...",
  appId: "..."
};'></textarea>
          <div class="mt-2 flex flex-wrap items-center gap-2">
            <button id="btnSaveConfig" class="rounded-xl bg-slate-900 text-white px-4 py-2 text-sm hover:bg-slate-800">Simpan & Hubungkan</button>
            <button id="btnClearConfig" class="rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm hover:bg-slate-50">Hapus Config (Demo)</button>
          </div>
          <div class="mt-2 text-xs text-slate-500" id="setupStatus">Status: belum ada konfigurasi.</div>
          <div class="mt-2 text-[11px] text-slate-500">
            Tips: paste hanya bagian <span class="font-mono">firebaseConfig</span> (object) dari Firebase Console. Aplikasi menerima JSON murni atau snippet <span class="font-mono">const firebaseConfig = {...}</span>.
          </div>
        </div>
        <div>
          <div class="text-sm font-semibold">2) Checklist Firebase Console</div>
          <div class="mt-2 rounded-2xl border border-slate-200 bg-white p-4 text-sm text-slate-600 leading-relaxed">
            <ul class="list-disc list-inside space-y-1">
              <li>Authentication → enable Email/Password</li>
              <li>Firestore → create database (Production) + lokasi asia-southeast1</li>
              <li>Buat koleksi: users, products, suppliers, purchases, orders, notifications, expenses</li>
              <li>(Opsional) Storage untuk gambar produk</li>
              <li>(Opsional) Cloud Functions untuk trigger notifikasi & WhatsApp API</li>
            </ul>
          </div>

          <div class="mt-4 text-sm font-semibold">3) Firestore Rules (contoh)</div>
          <pre class="mt-2 rounded-2xl border border-slate-200 bg-slate-50 p-3 text-xs overflow-auto"><code>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    match /products/{productId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.token.role == 'admin';
    }
    match /orders/{orderId} {
      allow read, write: if request.auth != null;
    }
  }
}</code></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div id="checkoutModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-slate-900/40" data-close-checkout></div>
    <div class="absolute inset-x-4 top-10 mx-auto max-w-2xl rounded-3xl bg-white border border-slate-200 shadow-soft p-5 fade-in">
      <div class="flex items-center justify-between">
        <div>
          <div class="font-semibold">Checkout Order</div>
          <div class="text-xs text-slate-500">Order akan masuk ke admin (Menunggu Konfirmasi Biaya Kirim).</div>
        </div>
        <button class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-slate-50" data-close-checkout>Tutup</button>
      </div>

      <form id="checkoutForm" class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
        <div class="md:col-span-2 rounded-2xl border border-slate-200 bg-slate-50 p-4">
          <div class="flex items-center justify-between">
            <div class="font-semibold">Ringkasan</div>
            <div class="text-sm text-slate-700">Subtotal: <span class="font-semibold mono" id="checkoutSubtotal">Rp0</span></div>
          </div>
          <div id="checkoutItems" class="mt-3 space-y-2 text-sm"></div>
        </div>
        <div>
          <label class="text-xs text-slate-500">Nama Penerima</label>
          <input id="shipName" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" required />
        </div>
        <div>
          <label class="text-xs text-slate-500">No. WhatsApp</label>
          <input id="shipPhone" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" placeholder="08xxxx" required />
        </div>
        <div class="md:col-span-2">
          <label class="text-xs text-slate-500">Alamat Pengiriman</label>
          <textarea id="shipAddress" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" rows="3" required></textarea>
        </div>
        <div class="md:col-span-2 flex items-center gap-2">
          <button class="flex-1 rounded-xl bg-emerald-600 px-4 py-2 text-sm text-white hover:bg-emerald-700" type="submit">Buat Order</button>
          <button id="btnCancelCheckout" class="rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm hover:bg-slate-50" type="button">Batal</button>
        </div>
      </form>
      <div class="mt-3 text-xs text-slate-500">Dengan membuat order, stok akan berkurang. Admin akan menentukan ongkir dan mengirim total pembayaran.</div>
    </div>
  </div>

  <!-- Thank You Overlay -->
  <canvas id="confettiCanvas" class="confetti hidden"></canvas>
  <div id="thankYou" class="fixed inset-0 z-[70] hidden">
    <div class="absolute inset-0 bg-slate-900/40"></div>
    <div class="absolute inset-x-4 top-10 mx-auto max-w-2xl rounded-3xl overflow-hidden border border-emerald-200 bg-white shadow-soft fade-in">
      <div class="relative p-6 bg-gradient-to-br from-emerald-600 to-lime-500 text-white">
        <div class="absolute -right-16 -top-16 h-52 w-52 rounded-full bg-white/15 blur-2xl"></div>
        <div class="absolute -left-16 -bottom-16 h-52 w-52 rounded-full bg-white/15 blur-2xl"></div>
        <div class="relative">
          <div class="text-sm font-medium">Pembayaran Terkonfirmasi</div>
          <div class="mt-1 text-2xl font-semibold">Terima kasih! Order Anda sedang diproses.</div>
          <div class="mt-2 text-white/90 text-sm">Kami sudah mencatat konfirmasi pembayaran dan membuat log notifikasi (system/whatsapp).</div>
        </div>
      </div>
      <div class="p-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="rounded-2xl border border-slate-200 p-4">
            <div class="text-xs text-slate-500">Order ID</div>
            <div class="mt-1 font-semibold mono" id="thankOrderId">—</div>
          </div>
          <div class="rounded-2xl border border-slate-200 p-4">
            <div class="text-xs text-slate-500">Total</div>
            <div class="mt-1 font-semibold mono" id="thankTotal">Rp0</div>
          </div>
          <div class="rounded-2xl border border-slate-200 p-4">
            <div class="text-xs text-slate-500">Status</div>
            <div class="mt-1 font-semibold" id="thankStatus">Pembayaran Dikonfirmasi</div>
          </div>
        </div>

        <div class="mt-4 rounded-2xl border border-emerald-200 bg-emerald-50 p-4 text-sm text-emerald-900">
          <div class="font-semibold">Langkah berikutnya</div>
          <div class="mt-1">Admin akan memproses pesanan Anda. Anda dapat memantau status di Riwayat Order.</div>
        </div>

        <div class="mt-5 flex items-center gap-2">
          <button id="btnCloseThank" class="flex-1 rounded-xl bg-slate-900 px-4 py-2 text-sm text-white hover:bg-slate-800">Kembali</button>
          <button id="btnOpenNotifFromThank" class="rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm hover:bg-slate-50">Lihat Log Notifikasi (Admin)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-[90] hidden">
    <div class="rounded-2xl bg-slate-900 text-white px-4 py-3 text-sm shadow-soft">Toast</div>
  </div>

  <script type="module">
    // Firebase (modular) via CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, doc, setDoc, getDoc, addDoc, updateDoc, deleteDoc,
      onSnapshot, query, where, orderBy, serverTimestamp, runTransaction, getDocs, limit
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, createUserWithEmailAndPassword,
      signInWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // ---------- Utilities ----------
    const $ = (s, el=document) => el.querySelector(s);
    const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));
    const fmtRp = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(Number(n||0));
    const fmtDate = (d) => {
      try{
        if(!d) return '-';
        if(typeof d === 'string') return new Date(d).toLocaleString('id-ID');
        if(d.toDate) return d.toDate().toLocaleString('id-ID');
        return new Date(d).toLocaleString('id-ID');
      } catch { return '-'; }
    };
    const uid = () => crypto.randomUUID?.() ?? (Date.now().toString(36)+Math.random().toString(36).slice(2));

    function toast(msg, type='info'){
      const el = $('#toast');
      const box = el.firstElementChild;
      box.textContent = msg;
      box.className = "rounded-2xl px-4 py-3 text-sm shadow-soft text-white " + (type==='error' ? "bg-rose-600" : type==='success' ? "bg-emerald-600" : "bg-slate-900");
      el.classList.remove('hidden');
      clearTimeout(toast._t);
      toast._t = setTimeout(() => el.classList.add('hidden'), 2600);
    }

    function escapeHtml(str=''){
      return String(str).replace(/[&<>'"]/g, (c)=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
    }

    // ---------- App State ----------
    const state = {
      firebase: { app: null, db: null, auth: null, enabled: false },
      user: null,
      profile: null, // {name,email,role}
      role: 'guest',
      view: 'catalog',
      adminTab: 'products',
      products: [],
      suppliers: [],
      purchases: [],
      ordersAll: [],
      ordersMine: [],
      notifications: [],
      expenses: [],
      cart: {}, // {productId: qty}
      unsub: [],
      demo: { enabled: true }
    };

    // ---------- Demo Local DB (fallback) ----------
    const demoKey = 'fruitshop_demoDB_v1';
    const demoEvent = 'fruitshop_demo_event_v1';

    function demoLoad(){
      const raw = localStorage.getItem(demoKey);
      if(raw) return JSON.parse(raw);
      const now = new Date().toISOString();
      const seed = {
        users: {},
        products: {
          p1: { name: 'Apel Fuji', price: 25000, stock: 30, category: 'Apel', imageUrl: '', createdAt: now },
          p2: { name: 'Pisang Cavendish', price: 18000, stock: 25, category: 'Pisang', imageUrl: '', createdAt: now },
          p3: { name: 'Jeruk Sunkist', price: 32000, stock: 18, category: 'Jeruk', imageUrl: '', createdAt: now },
          p4: { name: 'Mangga Harum Manis', price: 28000, stock: 14, category: 'Mangga', imageUrl: '', createdAt: now },
        },
        suppliers: {
          s1: { name: 'CV Buah Segar', contact: '08xx-xxxx-xxxx', createdAt: now }
        },
        purchases: {},
        orders: {},
        notifications: {},
        expenses: {}
      };
      localStorage.setItem(demoKey, JSON.stringify(seed));
      return seed;
    }
    function demoSave(db){
      localStorage.setItem(demoKey, JSON.stringify(db));
      window.dispatchEvent(new CustomEvent(demoEvent));
    }
    function demoCol(name){
      const db = demoLoad();
      return db[name] || {};
    }
    function demoSetDoc(col, id, data){
      const db = demoLoad();
      db[col] = db[col] || {};
      db[col][id] = { ...(db[col][id]||{}), ...data };
      demoSave(db);
      return { id, ...db[col][id] };
    }
    function demoAddDoc(col, data){
      const id = uid();
      demoSetDoc(col, id, { ...data, createdAt: data.createdAt || new Date().toISOString() });
      return { id, ...demoCol(col)[id] };
    }
    function demoDeleteDoc(col, id){
      const db = demoLoad();
      if(db[col] && db[col][id]) delete db[col][id];
      demoSave(db);
    }
    function demoGetDoc(col, id){
      const d = demoCol(col)[id];
      return d ? { id, ...d } : null;
    }
    function demoList(col){
      const m = demoCol(col);
      return Object.entries(m).map(([id, v]) => ({ id, ...v }));
    }

    function demoSubscribe(col, predicate, sortFn, cb){
      const run = () => {
        let list = demoList(col);
        if(predicate) list = list.filter(predicate);
        if(sortFn) list.sort(sortFn);
        cb(list);
      };
      run();
      const handler = () => run();
      window.addEventListener(demoEvent, handler);
      return () => window.removeEventListener(demoEvent, handler);
    }

    // ---------- Firebase init ----------
    const configKey = 'fruitshop_firebase_config_v1';

    // Menerima format JSON murni ATAU snippet dari Firebase Console:
    // const firebaseConfig = { apiKey: "...", ... };
    function parseFirebaseConfigInput(input){
      const t = String(input || '').trim();
      if(!t) throw new Error('Config kosong');

      // 1) Strict JSON
      try{
        const obj = JSON.parse(t);
        if(obj && typeof obj === 'object') return obj;
      } catch {}

      // 2) Snippet JS Firebase Console (extract object literal)
      let objText = t;
      const m = t.match(/firebaseConfig\s*=\s*(\{[\s\S]*?\})\s*;?/);
      if(m) objText = m[1];
      else {
        const first = t.indexOf('{');
        const last = t.lastIndexOf('}');
        if(first >= 0 && last > first) objText = t.slice(first, last + 1);
      }

      // 3) Evaluate as object literal (tolerant untuk trailing comma / key tanpa quotes)
      try{
        const cfg = (new Function(`return (${objText});`))();
        if(!cfg || typeof cfg !== 'object') throw new Error('Bukan object');
        return cfg;
      } catch {
        throw new Error('Tidak bisa parse firebaseConfig. Tempel object firebaseConfig dari Firebase Console (Web App config).');
      }
    }

    function validateFirebaseConfig(cfg){
      const required = ['apiKey','authDomain','projectId'];
      const missing = required.filter(k => !cfg?.[k]);
      if(missing.length) throw new Error('Field wajib tidak lengkap: ' + missing.join(', '));
    }

    function setConnectedUI(connected){
      const dot = $('#connDot');
      const text = $('#connText');
      const chip = $('#chipRealtime');
      if(connected){
        dot.className = 'h-2 w-2 rounded-full bg-emerald-500';
        text.textContent = 'Terhubung ke Firebase (Cloud)';
        chip.textContent = 'CLOUD';
        chip.className = 'rounded-full bg-emerald-100 text-emerald-800 px-2 py-0.5 text-xs font-medium';
      } else {
        dot.className = 'h-2 w-2 rounded-full bg-amber-500';
        text.textContent = 'Mode Demo (belum terhubung)';
        chip.textContent = 'DEMO';
        chip.className = 'rounded-full bg-amber-100 text-amber-800 px-2 py-0.5 text-xs font-medium';
      }
    }

    async function initFirebaseFromStorage(){
      const raw = localStorage.getItem(configKey);
      if(!raw) {
        state.firebase.enabled = false;
        state.demo.enabled = true;
        setConnectedUI(false);
        $('#setupStatus').textContent = 'Status: belum ada konfigurasi. Saat ini demo lokal.';
        return;
      }
      try{
        const config = JSON.parse(raw);
        validateFirebaseConfig(config);
        $('#firebaseConfigInput').value = JSON.stringify(config, null, 2);
        state.firebase.app = initializeApp(config);
        state.firebase.db = getFirestore(state.firebase.app);
        state.firebase.auth = getAuth(state.firebase.app);
        state.firebase.enabled = true;
        state.demo.enabled = false;
        setConnectedUI(true);
        $('#setupStatus').textContent = 'Status: konfigurasi tersimpan. Terhubung ke Firebase.';
      } catch (e){
        console.error(e);
        state.firebase.enabled = false;
        state.demo.enabled = true;
        setConnectedUI(false);
        $('#setupStatus').textContent = 'Status: config invalid. Gunakan demo lokal. ' + (e?.message || '');
        toast(e?.message ? ('Config Firebase invalid: ' + e.message) : 'Config Firebase tidak valid. Menggunakan mode demo.', 'error');
      }
    }

    // ---------- Data Layer (Firestore + Demo) ----------
    const data = {
      async ensureUserProfile(user, nameFallback=''){ // creates users/{uid}
        if(!user) return null;
        if(state.demo.enabled){
          const existing = demoGetDoc('users', user.uid);
          if(existing) return existing;
          const profile = { name: nameFallback || user.displayName || 'Customer', email: user.email, role: 'customer', createdAt: new Date().toISOString() };
          demoSetDoc('users', user.uid, profile);
          return { id: user.uid, ...profile };
        }
        const ref = doc(state.firebase.db, 'users', user.uid);
        const snap = await getDoc(ref);
        if(snap.exists()) return { id: snap.id, ...snap.data() };
        const profile = { name: nameFallback || user.displayName || 'Customer', email: user.email, role: 'customer', createdAt: serverTimestamp() };
        await setDoc(ref, profile);
        return { id: user.uid, ...profile };
      },

      subscribeProducts(cb){
        if(state.demo.enabled){
          return demoSubscribe('products', null, (a,b)=> (b.createdAt||'').localeCompare(a.createdAt||''), cb);
        }
        const qy = query(collection(state.firebase.db, 'products'), orderBy('name', 'asc'));
        return onSnapshot(qy, (snap)=>{
          const list = snap.docs.map(d=>({ id: d.id, ...d.data() }));
          cb(list);
        });
      },
      async upsertProduct(id, payload){
        if(state.demo.enabled){
          if(!id) return demoAddDoc('products', { ...payload, createdAt: new Date().toISOString() });
          return demoSetDoc('products', id, { ...payload, updatedAt: new Date().toISOString() });
        }
        if(!id){
          const ref = await addDoc(collection(state.firebase.db, 'products'), { ...payload, createdAt: serverTimestamp() });
          return { id: ref.id };
        } else {
          await updateDoc(doc(state.firebase.db, 'products', id), { ...payload, updatedAt: serverTimestamp() });
          return { id };
        }
      },
      async deleteProduct(id){
        if(state.demo.enabled) return demoDeleteDoc('products', id);
        return deleteDoc(doc(state.firebase.db, 'products', id));
      },

      subscribeSuppliers(cb){
        if(state.demo.enabled){
          return demoSubscribe('suppliers', null, (a,b)=> (b.createdAt||'').localeCompare(a.createdAt||''), cb);
        }
        const qy = query(collection(state.firebase.db, 'suppliers'), orderBy('name','asc'));
        return onSnapshot(qy, (snap)=> cb(snap.docs.map(d=>({id:d.id, ...d.data()}))));
      },
      async upsertSupplier(id, payload){
        if(state.demo.enabled){
          if(!id) return demoAddDoc('suppliers', { ...payload, createdAt: new Date().toISOString() });
          return demoSetDoc('suppliers', id, { ...payload, updatedAt: new Date().toISOString() });
        }
        if(!id){
          const ref = await addDoc(collection(state.firebase.db, 'suppliers'), { ...payload, createdAt: serverTimestamp() });
          return { id: ref.id };
        } else {
          await updateDoc(doc(state.firebase.db, 'suppliers', id), { ...payload, updatedAt: serverTimestamp() });
          return { id };
        }
      },
      async deleteSupplier(id){
        if(state.demo.enabled) return demoDeleteDoc('suppliers', id);
        return deleteDoc(doc(state.firebase.db, 'suppliers', id));
      },

      subscribePurchases(cb){
        if(state.demo.enabled){
          return demoSubscribe('purchases', null, (a,b)=> (b.date||'').localeCompare(a.date||''), cb);
        }
        const qy = query(collection(state.firebase.db, 'purchases'), orderBy('date','desc'));
        return onSnapshot(qy, (snap)=> cb(snap.docs.map(d=>({id:d.id, ...d.data()}))));
      },
      async addPurchase(payload){
        // payload: {supplierId, items:[{productId, qty, cost}], totalCost, note, date}
        if(state.demo.enabled){
          // update stock
          const db = demoLoad();
          for(const it of payload.items){
            const p = db.products[it.productId];
            if(p) p.stock = Number(p.stock||0) + Number(it.qty||0);
          }
          demoSave(db);
          return demoAddDoc('purchases', { ...payload, createdAt: new Date().toISOString() });
        }
        await runTransaction(state.firebase.db, async (tx)=>{
          for(const it of payload.items){
            const pref = doc(state.firebase.db, 'products', it.productId);
            const ps = await tx.get(pref);
            if(!ps.exists()) throw new Error('Produk tidak ditemukan');
            const stock = Number(ps.data().stock||0);
            tx.update(pref, { stock: stock + Number(it.qty||0), updatedAt: serverTimestamp() });
          }
          const purchRef = doc(collection(state.firebase.db, 'purchases'));
          tx.set(purchRef, { ...payload, createdAt: serverTimestamp() });
        });
      },

      subscribeOrdersAll(cb){
        if(state.demo.enabled){
          return demoSubscribe('orders', null, (a,b)=> (b.date||b.createdAt||'').localeCompare(a.date||a.createdAt||''), cb);
        }
        const qy = query(collection(state.firebase.db, 'orders'), orderBy('date','desc'));
        return onSnapshot(qy, (snap)=> cb(snap.docs.map(d=>({id:d.id, ...d.data()}))));
      },
      subscribeOrdersMine(userId, cb){
        if(state.demo.enabled){
          return demoSubscribe('orders', (o)=>o.userId===userId, (a,b)=> (b.date||b.createdAt||'').localeCompare(a.date||a.createdAt||''), cb);
        }
        const qy = query(collection(state.firebase.db, 'orders'), where('userId','==',userId), orderBy('date','desc'));
        return onSnapshot(qy, (snap)=> cb(snap.docs.map(d=>({id:d.id, ...d.data()}))));
      },

      async createOrder(order){
        // order: {userId, items, subtotal, shippingCost, totalPayment, status, paymentConfirmed, shipping, date}
        if(state.demo.enabled){
          // validate + decrement stock
          const db = demoLoad();
          for(const it of order.items){
            const p = db.products[it.productId];
            if(!p) throw new Error('Produk tidak ditemukan');
            if(Number(p.stock||0) < Number(it.qty||0)) throw new Error(`Stok tidak cukup untuk ${p.name}`);
          }
          for(const it of order.items){
            const p = db.products[it.productId];
            p.stock = Number(p.stock||0) - Number(it.qty||0);
          }
          demoSave(db);
          return demoAddDoc('orders', order);
        }
        // Firestore transaction: decrement stock + create order
        let newId = null;
        await runTransaction(state.firebase.db, async (tx)=>{
          for(const it of order.items){
            const pref = doc(state.firebase.db, 'products', it.productId);
            const ps = await tx.get(pref);
            if(!ps.exists()) throw new Error('Produk tidak ditemukan');
            const stock = Number(ps.data().stock||0);
            if(stock < Number(it.qty||0)) throw new Error(`Stok tidak cukup untuk ${ps.data().name}`);
            tx.update(pref, { stock: stock - Number(it.qty||0), updatedAt: serverTimestamp() });
          }
          const oref = doc(collection(state.firebase.db, 'orders'));
          newId = oref.id;
          tx.set(oref, { ...order, createdAt: serverTimestamp() });
        });
        return { id: newId };
      },

      async updateOrder(orderId, payload){
        if(state.demo.enabled){
          return demoSetDoc('orders', orderId, { ...payload, updatedAt: new Date().toISOString() });
        }
        return updateDoc(doc(state.firebase.db, 'orders', orderId), { ...payload, updatedAt: serverTimestamp() });
      },

      subscribeNotifications(cb){
        if(state.demo.enabled){
          return demoSubscribe('notifications', null, (a,b)=> (b.timestamp||b.createdAt||'').localeCompare(a.timestamp||a.createdAt||''), cb);
        }
        const qy = query(collection(state.firebase.db, 'notifications'), orderBy('timestamp','desc'));
        return onSnapshot(qy, (snap)=> cb(snap.docs.map(d=>({id:d.id, ...d.data()}))));
      },
      async addNotification(payload){
        if(state.demo.enabled){
          return demoAddDoc('notifications', { ...payload, timestamp: new Date().toISOString() });
        }
        return addDoc(collection(state.firebase.db, 'notifications'), { ...payload, timestamp: serverTimestamp() });
      },

      subscribeExpenses(cb){
        if(state.demo.enabled){
          return demoSubscribe('expenses', null, (a,b)=> (b.date||b.createdAt||'').localeCompare(a.date||a.createdAt||''), cb);
        }
        const qy = query(collection(state.firebase.db, 'expenses'), orderBy('date','desc'));
        return onSnapshot(qy, (snap)=> cb(snap.docs.map(d=>({id:d.id, ...d.data()}))));
      },
      async addExpense(payload){
        if(state.demo.enabled){
          return demoAddDoc('expenses', { ...payload, date: new Date().toISOString() });
        }
        return addDoc(collection(state.firebase.db, 'expenses'), { ...payload, date: serverTimestamp() });
      },

      async getUserProfile(uid){
        if(state.demo.enabled){
          const u = demoGetDoc('users', uid);
          return u;
        }
        const snap = await getDoc(doc(state.firebase.db, 'users', uid));
        return snap.exists() ? { id: snap.id, ...snap.data() } : null;
      }
    };

    // ---------- Rendering ----------
    function setRole(role){
      state.role = role || 'guest';
      $('#roleBadge').textContent = state.role;
      $('#statRole').textContent = state.role;
      const hint = $('#hintRole');
      hint.textContent = (state.role === 'admin')
        ? 'Anda admin. Panel Admin aktif.'
        : (state.role === 'customer')
          ? 'Anda customer. Checkout & riwayat order aktif.'
          : 'Login sebagai customer untuk checkout, atau set role admin di Firestore untuk membuka panel admin.';
    }

    function setUserUI(){
      const u = state.user;
      const loggedIn = !!u;
      $('#btnLogin').classList.toggle('hidden', loggedIn);
      $('#btnLogout').classList.toggle('hidden', !loggedIn);
      $('#statUser').textContent = loggedIn ? (state.profile?.name || u.email) : 'Guest';
      $('#customerEmail').textContent = loggedIn ? u.email : '—';
      $('#adminEmail').textContent = loggedIn ? u.email : '—';
    }

    function activeView(view){
      state.view = view;
      $$('.viewBtn').forEach(btn=>{
        const is = btn.dataset.view === view;
        btn.className = is ? 'viewBtn rounded-xl bg-slate-900 text-white px-4 py-2 text-sm' : 'viewBtn rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm hover:bg-slate-50';
      });
      ['catalog','customer','admin','reports'].forEach(v=>{
        $('#view-'+v).classList.toggle('hidden', v!==view);
      });

      // gate admin
      if(view==='admin'){
        const ok = state.role==='admin';
        $('#adminAccessDenied').classList.toggle('hidden', ok);
        // hide all admin content if denied
        const panel = $('.rounded-3xl', $('#view-admin'));
        // keep header but show deny message
      }
    }

    function activeAdminTab(tab){
      state.adminTab = tab;
      $$('.adminTab').forEach(btn=>{
        const is = btn.dataset.admin === tab;
        btn.className = is ? 'adminTab rounded-xl bg-slate-900 text-white px-4 py-2 text-sm' : 'adminTab rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm hover:bg-slate-50';
      });
      ['products','suppliers','purchases','orders','expenses','notifications'].forEach(t=>{
        $('#admin-'+t).classList.toggle('hidden', t!==tab);
      });
    }

    function buildCategoryOptions(products){
      const categories = Array.from(new Set(products.map(p=>p.category).filter(Boolean))).sort((a,b)=>a.localeCompare(b));
      const sel = $('#filterCategory');
      const current = sel.value;
      sel.innerHTML = '<option value="">Semua Kategori</option>' + categories.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
      if(categories.includes(current)) sel.value = current;
    }

    function productCard(p){
      const img = p.imageUrl?.trim();
      const initials = (p.name||'?').slice(0,1).toUpperCase();
      const stock = Number(p.stock||0);
      const disabled = stock<=0;
      const badge = disabled
        ? `<span class="rounded-full bg-rose-100 text-rose-800 px-2 py-0.5 text-xs font-medium">Habis</span>`
        : `<span class="rounded-full bg-emerald-100 text-emerald-800 px-2 py-0.5 text-xs font-medium">Stok: ${stock}</span>`;
      const media = img
        ? `<img src="${escapeHtml(img)}" alt="${escapeHtml(p.name)}" class="h-32 w-full object-cover rounded-2xl border border-slate-200" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'" />
           <div class="hidden h-32 w-full items-center justify-center rounded-2xl border border-slate-200 bg-gradient-to-br from-amber-50 to-emerald-50 text-3xl">${escapeHtml(initials)}</div>`
        : `<div class="h-32 w-full flex items-center justify-center rounded-2xl border border-slate-200 bg-gradient-to-br from-amber-50 to-emerald-50 text-3xl">${escapeHtml(initials)}</div>`;

      return `
        <div class="rounded-3xl border border-slate-200 bg-white p-4 shadow-soft">
          ${media}
          <div class="mt-3 flex items-start justify-between gap-2">
            <div>
              <div class="font-semibold leading-tight">${escapeHtml(p.name||'-')}</div>
              <div class="text-xs text-slate-500">${escapeHtml(p.category||'Tanpa kategori')}</div>
            </div>
            ${badge}
          </div>
          <div class="mt-3 flex items-center justify-between">
            <div class="font-semibold mono">${fmtRp(p.price||0)}</div>
            <button data-add="${escapeHtml(p.id)}" ${disabled?'disabled':''} class="rounded-xl ${disabled?'bg-slate-200 text-slate-500 cursor-not-allowed':'bg-slate-900 text-white hover:bg-slate-800'} px-3 py-2 text-sm">Tambah</button>
          </div>
        </div>
      `;
    }

    function renderProducts(){
      const q = $('#search').value.trim().toLowerCase();
      const cat = $('#filterCategory').value;
      let list = [...state.products];
      if(cat) list = list.filter(p => (p.category||'')===cat);
      if(q) list = list.filter(p => (p.name||'').toLowerCase().includes(q) || (p.category||'').toLowerCase().includes(q));

      const grid = $('#productsGrid');
      $('#statProducts').textContent = state.products.length;

      if(state.products.length===0){
        $('#emptyProducts').classList.remove('hidden');
        grid.innerHTML = '';
        return;
      }
      $('#emptyProducts').classList.add('hidden');
      grid.innerHTML = list.map(productCard).join('');
    }

    function cartItemsArray(){
      return Object.entries(state.cart)
        .map(([productId, qty]) => {
          const p = state.products.find(x=>x.id===productId);
          return p ? { productId, qty: Number(qty), name: p.name, price: Number(p.price||0), stock: Number(p.stock||0) } : null;
        })
        .filter(Boolean);
    }

    function cartSubtotal(){
      return cartItemsArray().reduce((s,it)=> s + it.price*it.qty, 0);
    }

    function renderCart(){
      const items = cartItemsArray();
      $('#cartCount').textContent = items.reduce((s,it)=>s+it.qty, 0);
      $('#cartMeta').textContent = `${items.length} produk`;
      $('#cartSubtotal').textContent = fmtRp(cartSubtotal());

      const box = $('#cartItems');
      if(items.length===0){
        box.innerHTML = `
          <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-600">Keranjang kosong. Tambahkan buah dari katalog.</div>
        `;
        return;
      }
      box.innerHTML = items.map(it=>`
        <div class="rounded-2xl border border-slate-200 p-3 mb-3">
          <div class="flex items-start justify-between gap-2">
            <div>
              <div class="font-semibold">${escapeHtml(it.name)}</div>
              <div class="text-xs text-slate-500 mono">${fmtRp(it.price)} • Stok: ${it.stock}</div>
            </div>
            <button data-remove="${escapeHtml(it.productId)}" class="rounded-xl border border-slate-200 bg-white px-3 py-1.5 text-xs hover:bg-slate-50">Hapus</button>
          </div>
          <div class="mt-3 flex items-center justify-between">
            <div class="inline-flex items-center rounded-xl border border-slate-200 overflow-hidden">
              <button data-dec="${escapeHtml(it.productId)}" class="px-3 py-2 text-sm hover:bg-slate-50">-</button>
              <div class="px-3 py-2 text-sm font-semibold mono">${it.qty}</div>
              <button data-inc="${escapeHtml(it.productId)}" class="px-3 py-2 text-sm hover:bg-slate-50">+</button>
            </div>
            <div class="font-semibold mono">${fmtRp(it.price*it.qty)}</div>
          </div>
        </div>
      `).join('');
    }

    function renderAdminProducts(){
      const el = $('#adminProductsList');
      if(state.products.length===0){
        el.innerHTML = `<div class="p-4 text-sm text-slate-600">Belum ada produk.</div>`;
        return;
      }
      el.innerHTML = state.products.map(p=>{
        const stock = Number(p.stock||0);
        return `
          <div class="p-4 border-b border-slate-100 hover:bg-slate-50 cursor-pointer" data-edit-product="${escapeHtml(p.id)}">
            <div class="flex items-start justify-between gap-2">
              <div>
                <div class="font-semibold">${escapeHtml(p.name||'-')}</div>
                <div class="text-xs text-slate-500">${escapeHtml(p.category||'Tanpa kategori')}</div>
              </div>
              <div class="text-right">
                <div class="font-semibold mono">${fmtRp(p.price||0)}</div>
                <div class="text-xs ${stock<=0?'text-rose-600':'text-emerald-700'}">Stok: ${stock}</div>
              </div>
            </div>
            <div class="mt-2 flex items-center justify-end gap-2">
              <button class="rounded-xl border border-slate-200 bg-white px-3 py-1.5 text-xs hover:bg-slate-50" data-delete-product="${escapeHtml(p.id)}">Hapus</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderSuppliers(){
      const sel = $('#purchaseSupplier');
      sel.innerHTML = state.suppliers.length
        ? state.suppliers.map(s=>`<option value="${escapeHtml(s.id)}">${escapeHtml(s.name)}</option>`).join('')
        : `<option value="">(Belum ada supplier)</option>`;

      const el = $('#adminSuppliersList');
      if(state.suppliers.length===0){
        el.innerHTML = `<div class="p-4 text-sm text-slate-600">Belum ada supplier.</div>`;
        return;
      }
      el.innerHTML = state.suppliers.map(s=>`
        <div class="p-4 border-b border-slate-100 hover:bg-slate-50 cursor-pointer" data-edit-supplier="${escapeHtml(s.id)}">
          <div class="flex items-start justify-between gap-2">
            <div>
              <div class="font-semibold">${escapeHtml(s.name||'-')}</div>
              <div class="text-xs text-slate-500">${escapeHtml(s.contact||'')}</div>
            </div>
            <button class="rounded-xl border border-slate-200 bg-white px-3 py-1.5 text-xs hover:bg-slate-50" data-delete-supplier="${escapeHtml(s.id)}">Hapus</button>
          </div>
        </div>
      `).join('');
    }

    function purchaseItemRow(itemId, initial={}){
      return `
        <div class="rounded-xl border border-slate-200 bg-white p-3" data-pitem="${escapeHtml(itemId)}">
          <div class="grid grid-cols-1 md:grid-cols-7 gap-2 items-end">
            <div class="md:col-span-3">
              <label class="text-[11px] text-slate-500">Produk</label>
              <select class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" data-pitem-product>
                ${state.products.map(p=>`<option value="${escapeHtml(p.id)}" ${initial.productId===p.id?'selected':''}>${escapeHtml(p.name)}</option>`).join('')}
              </select>
            </div>
            <div class="md:col-span-1">
              <label class="text-[11px] text-slate-500">Qty</label>
              <input type="number" min="1" value="${escapeHtml(initial.qty ?? 1)}" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" data-pitem-qty />
            </div>
            <div class="md:col-span-2">
              <label class="text-[11px] text-slate-500">Cost/item (Rp)</label>
              <input type="number" min="0" value="${escapeHtml(initial.cost ?? 0)}" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" data-pitem-cost />
            </div>
            <div class="md:col-span-1 flex justify-end">
              <button type="button" class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-slate-50" data-pitem-remove>Hapus</button>
            </div>
          </div>
        </div>
      `;
    }

    function renderPurchases(){
      const el = $('#adminPurchasesList');
      if(state.purchases.length===0){
        el.innerHTML = `<div class="p-4 text-sm text-slate-600">Belum ada pembelian.</div>`;
        return;
      }
      el.innerHTML = state.purchases.map(p=>{
        const supplier = state.suppliers.find(s=>s.id===p.supplierId);
        const items = (p.items||[]).map(it=>{
          const prod = state.products.find(x=>x.id===it.productId);
          return `${escapeHtml(prod?.name||it.productId)} × ${Number(it.qty||0)}`;
        }).join(', ');
        return `
          <div class="p-4 border-b border-slate-100">
            <div class="flex items-start justify-between gap-2">
              <div>
                <div class="font-semibold">${escapeHtml(supplier?.name || 'Supplier')}</div>
                <div class="text-xs text-slate-500">${escapeHtml(items)}</div>
                <div class="text-xs text-slate-500">${escapeHtml(p.note||'')}</div>
              </div>
              <div class="text-right">
                <div class="font-semibold mono">${fmtRp(p.totalCost||0)}</div>
                <div class="text-xs text-slate-500">${fmtDate(p.date || p.createdAt)}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function statusPill(status){
      const map = {
        'Menunggu Konfirmasi Biaya Kirim': 'bg-amber-100 text-amber-800',
        'Menunggu Pembayaran': 'bg-indigo-100 text-indigo-800',
        'Pembayaran Dikonfirmasi': 'bg-emerald-100 text-emerald-800',
        'Selesai': 'bg-slate-200 text-slate-800'
      };
      return `<span class="rounded-full px-2 py-0.5 text-xs font-medium ${map[status] || 'bg-slate-100 text-slate-700'}">${escapeHtml(status||'-')}</span>`;
    }

    function renderOrdersAdmin(){
      const el = $('#adminOrdersList');
      const f = $('#adminOrderFilter').value;
      let list = [...state.ordersAll];
      if(f) list = list.filter(o => (o.status||'')===f);

      $('#statOrders').textContent = state.ordersAll.filter(o=>['Menunggu Konfirmasi Biaya Kirim','Menunggu Pembayaran','Pembayaran Dikonfirmasi'].includes(o.status)).length;

      if(list.length===0){
        el.innerHTML = `<div class="p-4 text-sm text-slate-600">Belum ada order.</div>`;
        return;
      }

      el.innerHTML = list.map(o=>{
        const total = Number(o.totalPayment||0);
        const items = (o.items||[]).reduce((s,it)=>s+Number(it.qty||0),0);
        const pay = o.paymentConfirmed ? '<span class="text-emerald-700 text-xs font-semibold">PAID</span>' : '<span class="text-slate-500 text-xs">UNPAID</span>';
        return `
          <div class="p-4 border-b border-slate-100 hover:bg-slate-50 cursor-pointer" data-open-order="${escapeHtml(o.id)}">
            <div class="flex items-start justify-between gap-2">
              <div>
                <div class="font-semibold">Order <span class="mono">${escapeHtml(o.id.slice(0,8))}</span></div>
                <div class="text-xs text-slate-500">Items: ${items} • ${fmtDate(o.date || o.createdAt)}</div>
                <div class="mt-1">${statusPill(o.status)} <span class="ml-2">${pay}</span></div>
              </div>
              <div class="text-right">
                <div class="font-semibold mono">${fmtRp(total)}</div>
                <div class="text-xs text-slate-500">Ongkir: ${fmtRp(o.shippingCost||0)}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderOrderDetailAdmin(orderId){
      const o = state.ordersAll.find(x=>x.id===orderId);
      if(!o){
        $('#adminOrderDetail').innerHTML = 'Pilih salah satu order untuk mengatur ongkir dan status.';
        return;
      }
      const itemsHtml = (o.items||[]).map(it=>{
        const p = state.products.find(x=>x.id===it.productId);
        return `<div class="flex items-center justify-between"><div>${escapeHtml(p?.name||it.productId)} × <span class="mono">${Number(it.qty||0)}</span></div><div class="mono">${fmtRp((Number(it.price||0))*Number(it.qty||0))}</div></div>`;
      }).join('');

      const shipping = o.shipping || {};
      const canSetShip = (o.status === 'Menunggu Konfirmasi Biaya Kirim');
      const canMarkDone = (o.status === 'Pembayaran Dikonfirmasi');
      const canSetWaitingPay = (o.status === 'Menunggu Konfirmasi Biaya Kirim' || o.status === 'Menunggu Pembayaran');

      $('#adminOrderDetail').innerHTML = `
        <div class="space-y-3">
          <div>
            <div class="text-xs text-slate-500">Order ID</div>
            <div class="font-semibold mono">${escapeHtml(o.id)}</div>
          </div>
          <div class="rounded-xl bg-white border border-slate-200 p-3">
            <div class="font-semibold">Items</div>
            <div class="mt-2 space-y-1">${itemsHtml}</div>
            <div class="mt-2 border-t border-slate-100 pt-2 flex items-center justify-between">
              <div class="text-slate-600">Subtotal</div>
              <div class="font-semibold mono">${fmtRp(o.subtotal||0)}</div>
            </div>
          </div>

          <div class="rounded-xl bg-white border border-slate-200 p-3">
            <div class="font-semibold">Pengiriman</div>
            <div class="mt-2 text-xs text-slate-500">${escapeHtml(shipping.shipName||'-')} • ${escapeHtml(shipping.shipPhone||'-')}</div>
            <div class="mt-1 text-xs text-slate-500">${escapeHtml(shipping.shipAddress||'-')}</div>
            <div class="mt-3 grid grid-cols-2 gap-2 items-end">
              <div>
                <label class="text-[11px] text-slate-500">Biaya kirim (Rp)</label>
                <input id="adminShippingCost" type="number" min="0" class="mt-1 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" value="${Number(o.shippingCost||0)}" ${(!canSetWaitingPay)?'':'"'} />
              </div>
              <div>
                <div class="text-[11px] text-slate-500">Total pembayaran</div>
                <div class="mt-1 w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-sm font-semibold mono" id="adminTotalPayment">${fmtRp(o.totalPayment|| (Number(o.subtotal||0)+Number(o.shippingCost||0)))}</div>
              </div>
            </div>
            <div class="mt-3 flex flex-wrap gap-2">
              <button id="btnAdminApplyShipping" class="rounded-xl bg-emerald-600 px-4 py-2 text-sm text-white hover:bg-emerald-700" ${(!canSetWaitingPay)?'disabled':''}>Simpan Ongkir & Kirim Total</button>
              <button id="btnAdminMarkDone" class="rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm hover:bg-slate-50" ${(!canMarkDone)?'disabled':''}>Tandai Selesai</button>
            </div>
            <div class="mt-2 text-xs text-slate-500">Saat disimpan, sistem mencatat notifikasi (system + whatsapp) ke koleksi notifications.</div>
          </div>

          <div class="rounded-xl bg-white border border-slate-200 p-3">
            <div class="flex items-center justify-between">
              <div class="font-semibold">Status</div>
              ${statusPill(o.status)}
            </div>
            <div class="mt-2 text-xs text-slate-500">Payment confirmed: <span class="font-semibold">${o.paymentConfirmed ? 'true' : 'false'}</span></div>
          </div>
        </div>
      `;

      // Wire detail buttons
      const shipInput = $('#adminShippingCost');
      const totalEl = $('#adminTotalPayment');
      shipInput?.addEventListener('input', () => {
        const ship = Number(shipInput.value||0);
        const total = Number(o.subtotal||0) + ship;
        totalEl.textContent = fmtRp(total);
      });

      $('#btnAdminApplyShipping')?.addEventListener('click', async ()=>{
        if(state.role!=='admin') return toast('Akses admin diperlukan', 'error');
        try{
          const ship = Number(shipInput.value||0);
          const total = Number(o.subtotal||0) + ship;
          const status = 'Menunggu Pembayaran';
          await data.updateOrder(o.id, { shippingCost: ship, totalPayment: total, status });
          // Notifications
          const msg = `Total pembayaran order ${o.id.slice(0,8)}: ${fmtRp(total)} (subtotal ${fmtRp(o.subtotal||0)} + ongkir ${fmtRp(ship)}). Silakan lakukan pembayaran dan klik Konfirmasi Pembayaran.`;
          await data.addNotification({ orderId: o.id, message: msg, channel: 'system' });
          await data.addNotification({ orderId: o.id, message: `[WA] ${msg}`, channel: 'whatsapp' });
          toast('Ongkir disimpan & notifikasi dicatat.', 'success');
        } catch(e){
          console.error(e);
          toast(e.message || 'Gagal menyimpan ongkir', 'error');
        }
      });

      $('#btnAdminMarkDone')?.addEventListener('click', async ()=>{
        if(state.role!=='admin') return toast('Akses admin diperlukan', 'error');
        try{
          await data.updateOrder(o.id, { status: 'Selesai' });
          await data.addNotification({ orderId: o.id, message: `Order ${o.id.slice(0,8)} ditandai selesai. Terima kasih telah berbelanja!`, channel: 'system' });
          toast('Order ditandai selesai', 'success');
        } catch(e){
          console.error(e);
          toast('Gagal update status', 'error');
        }
      });
    }

    function renderCustomerOrders(){
      const el = $('#customerOrders');
      if(!state.user){
        el.innerHTML = `<div class="p-4 text-sm text-slate-600">Silakan login untuk melihat order.</div>`;
        $('#emptyCustomerOrders').classList.add('hidden');
        return;
      }
      if(state.ordersMine.length===0){
        $('#emptyCustomerOrders').classList.remove('hidden');
        el.innerHTML = '';
        return;
      }
      $('#emptyCustomerOrders').classList.add('hidden');

      el.innerHTML = state.ordersMine.map(o=>{
        const total = Number(o.totalPayment||0);
        const itemsCount = (o.items||[]).reduce((s,it)=>s+Number(it.qty||0),0);
        const canPay = o.status === 'Menunggu Pembayaran' && !o.paymentConfirmed;
        const btn = canPay
          ? `<button data-confirm-pay="${escapeHtml(o.id)}" class="rounded-xl bg-emerald-600 px-3 py-2 text-xs text-white hover:bg-emerald-700">Konfirmasi Pembayaran</button>`
          : `<button class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs text-slate-600" disabled>—</button>`;
        return `
          <div class="p-4">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
              <div>
                <div class="font-semibold">Order <span class="mono">${escapeHtml(o.id.slice(0,8))}</span></div>
                <div class="text-xs text-slate-500">${fmtDate(o.date || o.createdAt)} • Items: ${itemsCount}</div>
                <div class="mt-1">${statusPill(o.status)} ${o.paymentConfirmed ? '<span class="ml-2 text-emerald-700 text-xs font-semibold">PAID</span>' : ''}</div>
              </div>
              <div class="text-right">
                <div class="font-semibold mono">${fmtRp(total)}</div>
                <div class="text-xs text-slate-500">Ongkir: ${fmtRp(o.shippingCost||0)}</div>
                <div class="mt-2">${btn}</div>
              </div>
            </div>
            <div class="mt-3 rounded-2xl border border-slate-200 bg-slate-50 p-3 text-sm text-slate-700">
              <div class="flex items-center justify-between">
                <div class="font-semibold">Rincian</div>
                <div class="text-xs text-slate-500">Subtotal ${fmtRp(o.subtotal||0)}</div>
              </div>
              <div class="mt-2 space-y-1">
                ${(o.items||[]).map(it=>{
                  const p = state.products.find(x=>x.id===it.productId);
                  return `<div class="flex items-center justify-between"><div>${escapeHtml(p?.name||it.productId)} × <span class="mono">${Number(it.qty||0)}</span></div><div class="mono">${fmtRp((Number(it.price||0))*Number(it.qty||0))}</div></div>`;
                }).join('')}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderNotifications(){
      const el = $('#adminNotificationsList');
      if(state.notifications.length===0){
        el.innerHTML = `<div class="p-4 text-sm text-slate-600">Belum ada notifikasi.</div>`;
        return;
      }
      el.innerHTML = state.notifications.map(n=>`
        <div class="p-4 border-b border-slate-100">
          <div class="flex items-start justify-between gap-2">
            <div>
              <div class="font-semibold">${escapeHtml(n.channel||'system').toUpperCase()} • Order <span class="mono">${escapeHtml((n.orderId||'').slice(0,8))}</span></div>
              <div class="mt-1 text-sm text-slate-700">${escapeHtml(n.message||'')}</div>
              <div class="mt-1 text-xs text-slate-500">${fmtDate(n.timestamp || n.createdAt)}</div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function renderExpenses(){
      const el = $('#adminExpensesList');
      if(state.expenses.length===0){
        el.innerHTML = `<div class="p-4 text-sm text-slate-600">Belum ada biaya operasional.</div>`;
        return;
      }
      el.innerHTML = state.expenses.map(x=>`
        <div class="p-4 border-b border-slate-100">
          <div class="flex items-start justify-between gap-2">
            <div>
              <div class="font-semibold">${escapeHtml(x.category||'-')}</div>
              <div class="text-xs text-slate-500">${escapeHtml(x.note||'')}</div>
              <div class="text-xs text-slate-500">${fmtDate(x.date || x.createdAt)}</div>
            </div>
            <div class="font-semibold mono">${fmtRp(x.amount||0)}</div>
          </div>
        </div>
      `).join('');
    }

    function renderReports(){
      const paid = state.ordersAll.filter(o=>o.paymentConfirmed);
      const pendingShip = state.ordersAll.filter(o=>o.status==='Menunggu Konfirmasi Biaya Kirim').length;
      const pendingPay = state.ordersAll.filter(o=>o.status==='Menunggu Pembayaran' && !o.paymentConfirmed).length;
      const revenue = paid.reduce((s,o)=> s+Number(o.totalPayment||0), 0);
      const ops = state.expenses.reduce((s,e)=> s+Number(e.amount||0), 0);
      const gross = revenue - ops;

      const cards = [
        { title: 'Revenue (Paid)', val: fmtRp(revenue), sub: `${paid.length} order paid`, tone: 'emerald' },
        { title: 'Biaya Operasional', val: fmtRp(ops), sub: `${state.expenses.length} catatan`, tone: 'amber' },
        { title: 'Laba Kotor (Revenue - Ops)', val: fmtRp(gross), sub: 'Estimasi', tone: gross>=0 ? 'emerald' : 'rose' },
        { title: 'Order Pending', val: String(pendingShip + pendingPay), sub: `Ongkir: ${pendingShip} • Bayar: ${pendingPay}`, tone: 'indigo' },
      ];
      $('#reportCards').innerHTML = cards.map(c=>`
        <div class="rounded-2xl border border-slate-200 p-4">
          <div class="text-xs text-slate-500">${escapeHtml(c.title)}</div>
          <div class="mt-1 text-xl font-semibold mono">${escapeHtml(c.val)}</div>
          <div class="mt-1 text-xs text-slate-500">${escapeHtml(c.sub)}</div>
        </div>
      `).join('');

      const recentOrders = [...state.ordersAll].slice(0, 10);
      $('#reportRecentOrders').innerHTML = recentOrders.length ? recentOrders.map(o=>`
        <div class="p-3 border-b border-slate-100">
          <div class="flex items-center justify-between">
            <div class="font-semibold">${escapeHtml(o.id.slice(0,8))}</div>
            <div class="mono font-semibold">${fmtRp(o.totalPayment||0)}</div>
          </div>
          <div class="mt-1 text-xs text-slate-500">${fmtDate(o.date || o.createdAt)} • ${escapeHtml(o.status||'-')}</div>
        </div>
      `).join('') : `<div class="p-3 text-sm text-slate-600">Belum ada order.</div>`;

      const recentExpenses = [...state.expenses].slice(0, 10);
      $('#reportRecentExpenses').innerHTML = recentExpenses.length ? recentExpenses.map(e=>`
        <div class="p-3 border-b border-slate-100">
          <div class="flex items-center justify-between">
            <div class="font-semibold">${escapeHtml(e.category||'-')}</div>
            <div class="mono font-semibold">${fmtRp(e.amount||0)}</div>
          </div>
          <div class="mt-1 text-xs text-slate-500">${fmtDate(e.date || e.createdAt)} • ${escapeHtml(e.note||'')}</div>
        </div>
      `).join('') : `<div class="p-3 text-sm text-slate-600">Belum ada biaya.</div>`;
    }

    // ---------- Confetti ----------
    function startConfetti(durationMs=1800){
      const canvas = $('#confettiCanvas');
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      canvas.classList.remove('hidden');

      const colors = ['#10b981','#22c55e','#a3e635','#f59e0b','#60a5fa','#f43f5e'];
      const parts = Array.from({length: 160}).map(()=>({
        x: Math.random()*canvas.width,
        y: -20 - Math.random()*canvas.height*0.3,
        r: 3 + Math.random()*5,
        vy: 2 + Math.random()*5,
        vx: -2 + Math.random()*4,
        rot: Math.random()*Math.PI,
        vr: -0.2 + Math.random()*0.4,
        c: colors[Math.floor(Math.random()*colors.length)]
      }));

      const t0 = performance.now();
      function frame(t){
        const dt = 16;
        ctx.clearRect(0,0,canvas.width,canvas.height);
        for(const p of parts){
          p.x += p.vx;
          p.y += p.vy;
          p.rot += p.vr;
          p.vy += 0.02;
          if(p.y > canvas.height + 50){
            p.y = -20;
            p.x = Math.random()*canvas.width;
            p.vy = 2 + Math.random()*5;
          }
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rot);
          ctx.fillStyle = p.c;
          ctx.fillRect(-p.r, -p.r, p.r*2.2, p.r*1.4);
          ctx.restore();
        }
        if(t - t0 < durationMs) requestAnimationFrame(frame);
        else canvas.classList.add('hidden');
      }
      requestAnimationFrame(frame);
    }

    function openThankYou(order){
      $('#thankOrderId').textContent = order.id;
      $('#thankTotal').textContent = fmtRp(order.totalPayment||0);
      $('#thankStatus').textContent = order.status || 'Pembayaran Dikonfirmasi';
      $('#thankYou').classList.remove('hidden');
      startConfetti(2000);
    }

    // ---------- Subscriptions ----------
    function clearUnsub(){
      for(const u of state.unsub) try{u && u();}catch{}
      state.unsub = [];
    }

    function subscribeAll(){
      clearUnsub();

      state.unsub.push(data.subscribeProducts((list)=>{
        state.products = list;
        buildCategoryOptions(list);
        renderProducts();
        renderAdminProducts();
        renderCart();
        // update purchase form options
        // refresh purchase item selects
        const itemsBox = $('#purchaseItems');
        if(itemsBox.children.length===0 && state.role==='admin') addPurchaseItem();
      }));

      state.unsub.push(data.subscribeSuppliers((list)=>{
        state.suppliers = list;
        renderSuppliers();
      }));

      state.unsub.push(data.subscribePurchases((list)=>{
        state.purchases = list;
        renderPurchases();
      }));

      state.unsub.push(data.subscribeNotifications((list)=>{
        state.notifications = list;
        renderNotifications();
      }));

      state.unsub.push(data.subscribeExpenses((list)=>{
        state.expenses = list;
        renderExpenses();
        if(state.view==='reports') renderReports();
      }));

      state.unsub.push(data.subscribeOrdersAll((list)=>{
        state.ordersAll = list;
        renderOrdersAdmin();
        if(state.view==='reports') renderReports();
      }));

      if(state.user){
        state.unsub.push(data.subscribeOrdersMine(state.user.uid, (list)=>{
          state.ordersMine = list;
          renderCustomerOrders();
        }));
      } else {
        state.ordersMine = [];
        renderCustomerOrders();
      }
    }

    // ---------- Cart actions ----------
    function addToCart(productId, qty=1){
      const p = state.products.find(x=>x.id===productId);
      if(!p) return;
      const stock = Number(p.stock||0);
      const current = Number(state.cart[productId]||0);
      const next = current + qty;
      if(next > stock){
        toast('Stok tidak mencukupi', 'error');
        return;
      }
      state.cart[productId] = next;
      renderCart();
      toast('Ditambahkan ke keranjang', 'success');
    }

    function setCartQty(productId, qty){
      const p = state.products.find(x=>x.id===productId);
      if(!p) return;
      const stock = Number(p.stock||0);
      const q = Math.max(0, Math.min(Number(qty||0), stock));
      if(q<=0) delete state.cart[productId];
      else state.cart[productId] = q;
      renderCart();
    }

    // ---------- Checkout ----------
    function openCheckout(){
      const items = cartItemsArray();
      if(items.length===0) return toast('Keranjang kosong', 'error');
      if(!state.user) {
        openAuth();
        return toast('Login diperlukan untuk checkout', 'error');
      }
      if(state.role!=='customer' && state.role!=='admin'){
        return toast('Role tidak valid. Login ulang.', 'error');
      }
      // validate stock
      for(const it of items){
        if(it.qty > it.stock) return toast(`Stok tidak cukup untuk ${it.name}`, 'error');
      }
      $('#checkoutSubtotal').textContent = fmtRp(cartSubtotal());
      $('#checkoutItems').innerHTML = items.map(it=>`
        <div class="flex items-center justify-between">
          <div>${escapeHtml(it.name)} × <span class="mono">${it.qty}</span></div>
          <div class="mono">${fmtRp(it.price*it.qty)}</div>
        </div>
      `).join('');
      $('#checkoutModal').classList.remove('hidden');
      // prefills
      $('#shipName').value = state.profile?.name || '';
    }

    async function submitCheckout(){
      const items = cartItemsArray();
      if(items.length===0) return toast('Keranjang kosong', 'error');
      if(!state.user) return toast('Login diperlukan', 'error');

      const shipping = {
        shipName: $('#shipName').value.trim(),
        shipPhone: $('#shipPhone').value.trim(),
        shipAddress: $('#shipAddress').value.trim(),
      };
      if(!shipping.shipName || !shipping.shipPhone || !shipping.shipAddress){
        return toast('Lengkapi data pengiriman', 'error');
      }

      const order = {
        userId: state.user.uid,
        items: items.map(it=>({ productId: it.productId, name: it.name, price: it.price, qty: it.qty })),
        subtotal: cartSubtotal(),
        shippingCost: 0,
        totalPayment: cartSubtotal(),
        status: 'Menunggu Konfirmasi Biaya Kirim',
        paymentConfirmed: false,
        shipping,
        date: (state.demo.enabled ? new Date().toISOString() : serverTimestamp())
      };

      try{
        const ref = await data.createOrder(order);
        const orderId = ref?.id;

        // notification to admin (system log)
        const msg = `Order baru ${String(orderId||'').slice(0,8)} dibuat. Status: Menunggu Konfirmasi Biaya Kirim.`;
        await data.addNotification({ orderId, message: msg, channel: 'system' });

        // clear cart
        state.cart = {};
        renderCart();
        $('#checkoutModal').classList.add('hidden');
        $('#cartDrawer').classList.add('hidden');
        toast('Order dibuat. Menunggu ongkir dari admin.', 'success');
        activeView('customer');
      } catch(e){
        console.error(e);
        toast(e.message || 'Gagal membuat order', 'error');
      }
    }

    // ---------- Payment confirmation ----------
    async function confirmPayment(orderId){
      const o = state.ordersMine.find(x=>x.id===orderId) || state.ordersAll.find(x=>x.id===orderId);
      if(!o) return toast('Order tidak ditemukan', 'error');
      if(!state.user) return toast('Login diperlukan', 'error');
      if(o.userId !== state.user.uid && state.role!=='admin') return toast('Akses ditolak', 'error');
      if(o.status !== 'Menunggu Pembayaran') return toast('Order belum siap dibayar (menunggu ongkir/admin)', 'error');

      try{
        await data.updateOrder(orderId, { paymentConfirmed: true, status: 'Pembayaran Dikonfirmasi', paymentConfirmedAt: (state.demo.enabled? new Date().toISOString() : serverTimestamp()) });
        const msg = `Pembayaran dikonfirmasi untuk order ${orderId.slice(0,8)}. Terima kasih!`;
        await data.addNotification({ orderId, message: msg, channel: 'system' });
        await data.addNotification({ orderId, message: `[WA] ${msg}`, channel: 'whatsapp' });
        toast('Konfirmasi pembayaran tersimpan', 'success');
        openThankYou({ ...o, id: orderId, status: 'Pembayaran Dikonfirmasi' });
      } catch(e){
        console.error(e);
        toast('Gagal konfirmasi pembayaran', 'error');
      }
    }

    // ---------- Forms: Products ----------
    function resetProductForm(){
      $('#productId').value = '';
      $('#productName').value = '';
      $('#productPrice').value = '';
      $('#productStock').value = '';
      $('#productCategory').value = '';
      $('#productImageUrl').value = '';
    }

    function fillProductForm(p){
      $('#productId').value = p.id;
      $('#productName').value = p.name || '';
      $('#productPrice').value = Number(p.price||0);
      $('#productStock').value = Number(p.stock||0);
      $('#productCategory').value = p.category || '';
      $('#productImageUrl').value = p.imageUrl || '';
    }

    // ---------- Forms: Suppliers ----------
    function resetSupplierForm(){
      $('#supplierId').value='';
      $('#supplierName').value='';
      $('#supplierContact').value='';
    }

    function fillSupplierForm(s){
      $('#supplierId').value=s.id;
      $('#supplierName').value=s.name||'';
      $('#supplierContact').value=s.contact||'';
    }

    // ---------- Purchases form ----------
    function addPurchaseItem(initial){
      const itemsBox = $('#purchaseItems');
      const itemId = uid();
      itemsBox.insertAdjacentHTML('beforeend', purchaseItemRow(itemId, initial));
    }

    function readPurchaseItems(){
      const rows = $$('#purchaseItems [data-pitem]');
      const items = [];
      for(const r of rows){
        const productId = $('[data-pitem-product]', r).value;
        const qty = Number($('[data-pitem-qty]', r).value||0);
        const cost = Number($('[data-pitem-cost]', r).value||0);
        if(!productId || qty<=0) continue;
        items.push({ productId, qty, cost });
      }
      return items;
    }

    // ---------- Auth ----------
    let authMode = 'login';
    function openAuth(){
      $('#authModal').classList.remove('hidden');
      setAuthMode(authMode);
    }
    function closeAuth(){
      $('#authModal').classList.add('hidden');
      $('#authError').textContent = '';
    }
    function setAuthMode(mode){
      authMode = mode;
      const isLogin = mode==='login';
      $('#authTitle').textContent = isLogin ? 'Login' : 'Registrasi';
      $('#btnAuthSubmit').textContent = isLogin ? 'Masuk' : 'Buat Akun';
      $('#rowName').classList.toggle('hidden', isLogin);
      $('#btnModeLogin').className = isLogin ? 'rounded-xl bg-slate-900 text-white px-3 py-2 text-sm' : 'rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-slate-50';
      $('#btnModeRegister').className = !isLogin ? 'rounded-xl bg-slate-900 text-white px-3 py-2 text-sm' : 'rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-slate-50';
    }

    async function doAuth(email, password, name=''){
      if(state.demo.enabled){
        // Demo auth: emulate uid based on email
        const duid = 'demo_' + btoa(email).replace(/=+$/,'');
        state.user = { uid: duid, email };
        state.profile = await data.ensureUserProfile(state.user, name || 'Customer');
        setRole(state.profile?.role || 'customer');
        setUserUI();
        subscribeAll();
        closeAuth();
        toast('Login demo berhasil', 'success');
        return;
      }

      const auth = state.firebase.auth;
      try{
        if(authMode==='login'){
          await signInWithEmailAndPassword(auth, email, password);
        } else {
          const cred = await createUserWithEmailAndPassword(auth, email, password);
          await data.ensureUserProfile(cred.user, name || 'Customer');
        }
        closeAuth();
      } catch(e){
        console.error(e);
        $('#authError').textContent = e.message || 'Gagal autentikasi';
      }
    }

    // ---------- Setup Modal ----------
    function openSetup(){
      $('#setupModal').classList.remove('hidden');
      const raw = localStorage.getItem(configKey);
      if(raw) $('#firebaseConfigInput').value = JSON.stringify(JSON.parse(raw), null, 2);
    }
    function closeSetup(){
      $('#setupModal').classList.add('hidden');
    }

    // ---------- Boot ----------
    async function boot(){
      // UI wires
      $('#btnOpenSetup').addEventListener('click', openSetup);
      $('[data-close-setup]').addEventListener('click', closeSetup);
      $('[data-close-auth]').addEventListener('click', closeAuth);
      $('[data-close-cart]').addEventListener('click', () => $('#cartDrawer').classList.add('hidden'));
      $('[data-close-checkout]').addEventListener('click', ()=> $('#checkoutModal').classList.add('hidden'));
      $('#btnCancelCheckout').addEventListener('click', ()=> $('#checkoutModal').classList.add('hidden'));
      $('#btnCart').addEventListener('click', ()=>{ $('#cartDrawer').classList.remove('hidden'); renderCart(); });
      $('#btnCheckout').addEventListener('click', openCheckout);
      $('#btnLogin').addEventListener('click', openAuth);
      $('#btnLogout').addEventListener('click', async ()=>{
        try{
          if(state.demo.enabled){
            state.user = null; state.profile = null; setRole('guest'); setUserUI(); subscribeAll();
            toast('Logout demo', 'success');
            return;
          }
          await signOut(state.firebase.auth);
        } catch(e){
          console.error(e);
          toast('Gagal logout', 'error');
        }
      });

      $('#btnGoCatalog').addEventListener('click', ()=>activeView('catalog'));
      $('#btnGoDashboard').addEventListener('click', ()=>{
        if(state.role==='admin') activeView('admin');
        else activeView('customer');
      });

      $$('.viewBtn').forEach(btn=> btn.addEventListener('click', ()=>{
        const v = btn.dataset.view;
        if(v==='admin' && state.role!=='admin'){
          activeView('admin');
          toast('Tab admin membutuhkan role admin', 'error');
          return;
        }
        if(v==='customer' && !state.user){
          activeView('customer');
          toast('Login untuk akses pelanggan', 'error');
          return;
        }
        activeView(v);
        if(v==='reports') renderReports();
      }));

      $$('.adminTab').forEach(btn=> btn.addEventListener('click', ()=>{
        if(state.role!=='admin') return toast('Akses admin diperlukan', 'error');
        activeAdminTab(btn.dataset.admin);
      }));

      $('#search').addEventListener('input', renderProducts);
      $('#filterCategory').addEventListener('change', renderProducts);

      // Delegation: catalog add buttons
      $('#productsGrid').addEventListener('click', (e)=>{
        const btn = e.target.closest('[data-add]');
        if(!btn) return;
        addToCart(btn.dataset.add, 1);
      });

      // Delegation: cart
      $('#cartItems').addEventListener('click', (e)=>{
        const inc = e.target.closest('[data-inc]');
        const dec = e.target.closest('[data-dec]');
        const rem = e.target.closest('[data-remove]');
        if(inc) return addToCart(inc.dataset.inc, 1);
        if(dec) return setCartQty(dec.dataset.dec, Number(state.cart[dec.dataset.dec]||0)-1);
        if(rem) return setCartQty(rem.dataset.remove, 0);
      });

      // Auth mode buttons
      $('#btnModeLogin').addEventListener('click', ()=>setAuthMode('login'));
      $('#btnModeRegister').addEventListener('click', ()=>setAuthMode('register'));

      $('#authForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        $('#authError').textContent='';
        const email = $('#authEmail').value.trim();
        const pass = $('#authPassword').value;
        const name = $('#authName').value.trim();
        if(authMode==='register' && !name) return $('#authError').textContent = 'Nama wajib diisi untuk registrasi.';
        await doAuth(email, pass, name);
      });

      // Setup actions
      $('#btnSaveConfig').addEventListener('click', async ()=>{
        try{
          const txt = $('#firebaseConfigInput').value;
          const cfg = parseFirebaseConfigInput(txt);
          validateFirebaseConfig(cfg);
          localStorage.setItem(configKey, JSON.stringify(cfg));
          $('#setupStatus').textContent = 'Status: konfigurasi tersimpan. Mencoba menghubungkan ke Firebase...';
          toast('Config tersimpan. Menghubungkan...', 'success');
          await initFirebaseFromStorage();
          await initAuthListener();
          subscribeAll();
        } catch(e){
          console.error(e);
          const msg = e?.message || 'Config tidak valid';
          $('#setupStatus').textContent = 'Status: gagal memproses config. ' + msg;
          toast(msg, 'error');
        }
      });
      $('#btnClearConfig').addEventListener('click', async ()=>{
        localStorage.removeItem(configKey);
        toast('Config dihapus. Mode demo aktif.', 'success');
        await initFirebaseFromStorage();
        // reset user
        state.user = null; state.profile = null;
        setRole('guest');
        setUserUI();
        subscribeAll();
      });

      // Checkout submit
      $('#checkoutForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        await submitCheckout();
      });

      // Admin: product form
      $('#productForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        if(state.role!=='admin') return toast('Akses admin diperlukan', 'error');
        const id = $('#productId').value || '';
        const payload = {
          name: $('#productName').value.trim(),
          price: Number($('#productPrice').value||0),
          stock: Number($('#productStock').value||0),
          category: $('#productCategory').value.trim(),
          imageUrl: $('#productImageUrl').value.trim(),
        };
        try{
          await data.upsertProduct(id || null, payload);
          resetProductForm();
          toast('Produk tersimpan', 'success');
        } catch(e){
          console.error(e);
          toast('Gagal simpan produk', 'error');
        }
      });
      $('#btnProductReset').addEventListener('click', resetProductForm);

      $('#adminProductsList').addEventListener('click', async (e)=>{
        const edit = e.target.closest('[data-edit-product]');
        const del = e.target.closest('[data-delete-product]');
        if(edit){
          const p = state.products.find(x=>x.id===edit.dataset.editProduct);
          if(p) fillProductForm(p);
        }
        if(del){
          if(state.role!=='admin') return toast('Akses admin diperlukan', 'error');
          const id = del.dataset.deleteProduct;
          if(!confirm('Hapus produk ini?')) return;
          try{ await data.deleteProduct(id); toast('Produk dihapus', 'success'); } catch(e){ toast('Gagal hapus', 'error'); }
        }
      });

      // Admin: supplier form
      $('#supplierForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        if(state.role!=='admin') return toast('Akses admin diperlukan', 'error');
        const id = $('#supplierId').value || '';
        const payload = { name: $('#supplierName').value.trim(), contact: $('#supplierContact').value.trim() };
        try{ await data.upsertSupplier(id||null, payload); resetSupplierForm(); toast('Supplier tersimpan', 'success'); } catch(e){ toast('Gagal simpan supplier','error'); }
      });
      $('#btnSupplierReset').addEventListener('click', resetSupplierForm);

      $('#adminSuppliersList').addEventListener('click', async (e)=>{
        const edit = e.target.closest('[data-edit-supplier]');
        const del = e.target.closest('[data-delete-supplier]');
        if(edit){
          const s = state.suppliers.find(x=>x.id===edit.dataset.editSupplier);
          if(s) fillSupplierForm(s);
        }
        if(del){
          if(state.role!=='admin') return toast('Akses admin diperlukan', 'error');
          const id = del.dataset.deleteSupplier;
          if(!confirm('Hapus supplier ini?')) return;
          try{ await data.deleteSupplier(id); toast('Supplier dihapus', 'success'); } catch(e){ toast('Gagal hapus', 'error'); }
        }
      });

      // Admin: purchases
      $('#btnAddPurchaseItem').addEventListener('click', ()=>{
        if(state.role!=='admin') return toast('Akses admin diperlukan', 'error');
        if(state.products.length===0) return toast('Tambahkan produk dulu', 'error');
        addPurchaseItem({ productId: state.products[0]?.id, qty: 1, cost: 0 });
      });
      $('#purchaseItems').addEventListener('click', (e)=>{
        const rm = e.target.closest('[data-pitem-remove]');
        if(!rm) return;
        rm.closest('[data-pitem]').remove();
      });

      $('#purchaseForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        if(state.role!=='admin') return toast('Akses admin diperlukan', 'error');
        const supplierId = $('#purchaseSupplier').value;
        const items = readPurchaseItems();
        if(!supplierId) return toast('Pilih supplier', 'error');
        if(items.length===0) return toast('Tambahkan item pembelian', 'error');
        const totalCost = items.reduce((s,it)=> s + Number(it.qty||0)*Number(it.cost||0), 0);
        const payload = {
          supplierId,
          items,
          totalCost,
          note: $('#purchaseNote').value.trim(),
          date: (state.demo.enabled ? new Date().toISOString() : serverTimestamp())
        };
        try{
          await data.addPurchase(payload);
          $('#purchaseNote').value='';
          $('#purchaseItems').innerHTML='';
          addPurchaseItem({ productId: state.products[0]?.id, qty: 1, cost: 0 });
          toast('Pembelian tersimpan & stok bertambah', 'success');
        } catch(e){
          console.error(e);
          toast(e.message || 'Gagal simpan pembelian', 'error');
        }
      });

      // Admin: orders
      $('#adminOrderFilter').addEventListener('change', renderOrdersAdmin);
      $('#adminOrdersList').addEventListener('click', (e)=>{
        const open = e.target.closest('[data-open-order]');
        if(!open) return;
        if(state.role!=='admin') return toast('Akses admin diperlukan', 'error');
        renderOrderDetailAdmin(open.dataset.openOrder);
      });

      // Expenses
      $('#expenseForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        if(state.role!=='admin') return toast('Akses admin diperlukan', 'error');
        const payload = {
          category: $('#expenseCategory').value.trim(),
          amount: Number($('#expenseAmount').value||0),
          note: $('#expenseNote').value.trim(),
          date: (state.demo.enabled ? new Date().toISOString() : serverTimestamp())
        };
        try{ await data.addExpense(payload); $('#expenseCategory').value=''; $('#expenseAmount').value=''; $('#expenseNote').value=''; toast('Biaya tersimpan','success'); } catch(e){ toast('Gagal simpan biaya','error'); }
      });

      // Customer: confirm payment
      $('#customerOrders').addEventListener('click', async (e)=>{
        const btn = e.target.closest('[data-confirm-pay]');
        if(!btn) return;
        if(!confirm('Anda sudah melakukan transfer/e-wallet? Sistem akan mencatat konfirmasi pembayaran.')) return;
        await confirmPayment(btn.dataset.confirmPay);
      });

      // Thank you
      $('#btnCloseThank').addEventListener('click', ()=> $('#thankYou').classList.add('hidden'));
      $('#btnOpenNotifFromThank').addEventListener('click', ()=>{
        $('#thankYou').classList.add('hidden');
        if(state.role==='admin'){
          activeView('admin');
          activeAdminTab('notifications');
        } else {
          toast('Log notifikasi hanya terlihat admin', 'error');
        }
      });

      // Reports
      $('#btnRefreshReports').addEventListener('click', renderReports);

      // init
      await initFirebaseFromStorage();
      await initAuthListener();
      subscribeAll();
      renderCart();
      activeView('catalog');
      activeAdminTab('products');

      // Seed purchase item if admin later
      if($('#purchaseItems').children.length===0) addPurchaseItem({ productId: state.products[0]?.id, qty: 1, cost: 0 });
    }

    async function initAuthListener(){
      // in demo mode, no listener
      if(state.demo.enabled){
        setUserUI();
        setRole('guest');
        return;
      }
      const auth = state.firebase.auth;
      onAuthStateChanged(auth, async (user)=>{
        state.user = user;
        if(user){
          state.profile = await data.ensureUserProfile(user);
          // reload profile to reflect role updates
          const p2 = await data.getUserProfile(user.uid);
          state.profile = p2 || state.profile;
          setRole(state.profile?.role || 'customer');
        } else {
          state.profile = null;
          setRole('guest');
        }
        setUserUI();
        subscribeAll();
        if(state.role==='admin'){
          // stay on admin view if already
        }
      });
    }

    // Global click-to-close backdrops
    document.addEventListener('click', (e)=>{
      if(e.target.matches('[data-close-auth]')) closeAuth();
      if(e.target.matches('[data-close-setup]')) closeSetup();
      if(e.target.matches('[data-close-cart]')) $('#cartDrawer').classList.add('hidden');
      if(e.target.matches('[data-close-checkout]')) $('#checkoutModal').classList.add('hidden');
    });

    // View gating: if customer view opened while not logged in
    const origActiveView = activeView;
    activeView = function(view){
      if(view==='customer' && !state.user){
        origActiveView(view);
        return;
      }
      if(view==='admin' && state.role!=='admin'){
        origActiveView(view);
        return;
      }
      origActiveView(view);
    }

    // Extra delegation: purchase item if products updated
    window.addEventListener('resize', ()=>{
      const canvas = $('#confettiCanvas');
      if(!canvas.classList.contains('hidden')){
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
    });

    // Delegate clicks in catalog/admin for add/edit etc
    document.addEventListener('click', (e)=>{
      // view-only: open cart from header is already
      // purchase item ensures
      // admin deny quick nav
      if(e.target.closest('#view-admin') && state.role!=='admin'){
        // allow switching tabs but show toast
      }
    });

    // Purchase items initial row button safety
    function ensurePurchaseItems(){
      const box = $('#purchaseItems');
      if(box.children.length===0 && state.products.length>0) addPurchaseItem({ productId: state.products[0].id, qty: 1, cost: 0 });
    }

    // keep checkout subtotal updated if cart changes

    // Subscribe to demo changes for counts
    window.addEventListener(demoEvent, ()=>{
      // noop, subscriptions handle re-render
    });

    // Update role badge at start
    setConnectedUI(false);
    setUserUI();
    setRole('guest');

    // Catalog event bridging
    $('#productsGrid'); // ensure element exists

    // Fix a minor rendering of admin shipping input attribute
    // (Done by logic in renderOrderDetailAdmin; no extra patch required.)

    // Start
    boot();

  </script>
</body>
</html>
